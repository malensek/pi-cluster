#!/usr/bin/env bash
################################################################################
# install-updates - downloads all available updates to a shared location and
# then starts the install process in parallel across the cluster.
################################################################################

source "$(cd "$(dirname "$0")" && pwd)/picle-functions.sh"

now=$(date '+%F')
dir="${UPDATE_DIR}/${now}"

echo "Creating update directory: ${dir}"
mkdir -p "${dir}" 

echo "Downloading updates..."
pacman --sync --refresh --sysupgrade --downloadonly --noconfirm --cachedir "${dir}"

echo "Installing updates..."
dssh -t10 -jf ${PICLE_CONF}/cluster-members.txt \
    "pacman --upgrade --noprogressbar --noconfirm ${dir}/*"

echo "Complete."
